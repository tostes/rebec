{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{% trans "Create Trial" %}{% endblock %}

{% block content %}
<div class="module">
  <h2>{% trans "Create Trial" %}</h2>
  {% if save_error %}
  <p class="errornote">{% trans "There was a problem saving the trial. Please review the form and try again." %}</p>
  {% endif %}
  <form method="post" novalidate>
    {% csrf_token %}
    {% if trial_form.non_field_errors %}
    <div class="errornote">
      {{ trial_form.non_field_errors|join:" " }}
    </div>
    {% endif %}
    <fieldset class="module aligned">
      {% for field in trial_form %}
      <div class="form-row{% if field.errors %} errors{% endif %}">
        {{ field.label_tag }}
        {{ field }}
        {% if field.help_text %}
        <p class="help">{{ field.help_text }}</p>
        {% endif %}
        {% for error in field.errors %}
        <p class="errornote">{{ error }}</p>
        {% endfor %}
      </div>
      {% endfor %}
    </fieldset>

    {% for config in formsets %}
    <div class="inline-group" data-formset-prefix="{{ config.formset.prefix }}">
      <h3>{{ config.title }}</h3>
      {{ config.formset.management_form }}
      {% if config.formset.non_form_errors %}
      <div class="errornote">
        {{ config.formset.non_form_errors|join:" " }}
      </div>
      {% endif %}
      <div data-formset-forms>
        {% for form in config.formset %}
        <div class="inline-related{% if form.errors %} errors{% endif %}" data-formset-form>
          {% for hidden in form.hidden_fields %}
          {{ hidden }}
          {% endfor %}
          <fieldset class="module aligned">
            {% for field in form.visible_fields %}
            <div class="form-row{% if field.errors %} errors{% endif %}">
              {{ field.label_tag }}
              {{ field }}
              {% for error in field.errors %}
              <p class="errornote">{{ error }}</p>
              {% endfor %}
            </div>
            {% endfor %}
            {% if config.formset.can_delete %}
            <div class="form-row delete-row">
              {{ form.DELETE }}
              <label for="{{ form.DELETE.id_for_label }}">{% trans "Delete" %}</label>
            </div>
            {% endif %}
          </fieldset>
          {% if form.non_field_errors %}
          <div class="errornote">
            {{ form.non_field_errors|join:" " }}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <template data-empty-form>
        <div class="inline-related" data-formset-form>
          {% with form=config.formset.empty_form %}
          {% for hidden in form.hidden_fields %}
          {{ hidden.as_widget }}
          {% endfor %}
          <fieldset class="module aligned">
            {% for field in form.visible_fields %}
            <div class="form-row">
              {{ field.label_tag }}
              {{ field.as_widget }}
            </div>
            {% endfor %}
            {% if config.formset.can_delete %}
            <div class="form-row delete-row">
              {{ form.DELETE.as_widget }}
              <label for="{{ form.DELETE.id_for_label }}">{% trans "Delete" %}</label>
            </div>
            {% endif %}
          </fieldset>
          {% endwith %}
        </div>
      </template>
      <p class="add-row"><a href="#" data-add-inline>{{ config.add_text }}</a></p>
    </div>
    {% endfor %}

    <div class="submit-row">
      <button type="submit" class="default">{% trans "Save" %}</button>
      <a class="button cancel-link" href="{% url 'trial-list' %}">{% trans "Cancel" %}</a>
    </div>
  </form>
</div>

<script>
(function() {
  document.querySelectorAll('[data-formset-prefix]').forEach(function(container) {
    const prefix = container.getAttribute('data-formset-prefix');
    const addButton = container.querySelector('[data-add-inline]');
    const template = container.querySelector('template[data-empty-form]');
    const formsContainer = container.querySelector('[data-formset-forms]');
    if (!addButton || !template || !formsContainer) {
      return;
    }
    const totalFormsInput = container.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');
    if (!totalFormsInput) {
      return;
    }
    addButton.addEventListener('click', function(event) {
      event.preventDefault();
      const currentIndex = parseInt(totalFormsInput.value, 10) || 0;
      const markup = template.innerHTML.replace(/__prefix__/g, currentIndex);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = markup;
      const newForm = wrapper.firstElementChild;
      if (!newForm) {
        return;
      }
      formsContainer.appendChild(newForm);
      totalFormsInput.value = currentIndex + 1;
    });
  });
})();
</script>
{% endblock %}
